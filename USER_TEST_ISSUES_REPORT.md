# ユーザーテスト問題調査レポート

## 調査日時
2025-08-18

## 報告された問題

1. **詳細検索で結果が0件になる問題**
2. **ガントチャート画面のテーブル表示でページネーション不足**
3. **案件画面のコメント数表示の不整合**

---

## 1. 詳細検索で結果が0件になる問題

### 問題の詳細
- 詳細画面で全ての検索条件を「すべて」に設定しても検索結果は0件

### 原因分析

#### `/web/app/search/page.tsx` の調査結果

**問題点1: API関数の未定義**
- 75行目: `api.getTemplates()` が呼び出されているが、この関数は `/web/app/lib/api-client.ts` に存在しない
- 119行目: `api.searchTemplates()` が呼び出されているが、この関数も存在しない

**問題点2: searchTemplates関数の欠落**
```typescript
// api-client.tsの現在の定義（127-128行目）
searchCases: (params: any) => apiClient.get('/search/cases', { params }),
searchSteps: (params: any) => apiClient.get('/search/steps', { params }),
// searchTemplatesがない！
```

**結果**
- テンプレート検索時にエラーが発生し、検索処理全体が失敗している可能性が高い
- エラーがcatchされているため、ユーザーには結果が0件として表示される

### 必要な修正
1. `api-client.ts`に以下を追加:
   - `getTemplates()` 関数
   - `searchTemplates()` 関数

---

## 2. ガントチャート画面のテーブル表示でページネーション不足

### 問題の詳細
- テーブル表示モードで改ページボタンがないため、全てのデータが見られない

### 原因分析

#### `/web/app/gantt/page.tsx` の調査結果

**問題点: ハードコードされた表示件数制限**
- 338行目: `tasks.slice(0, 20).map((task) => ...)`
- 最初の20件のみが表示され、それ以降はアクセス不可

**現在の実装**
```typescript
{tasks.slice(0, 20).map((task) => (
  // タスク行の表示
))}
{tasks.length > 20 && (
  <div className="p-3 bg-gray-50 text-center text-sm text-gray-600">
    他 {tasks.length - 20} 件のタスク
  </div>
)}
```

**結果**
- 20件を超えるタスクがある場合、「他 N 件のタスク」と表示されるだけ
- ページネーションやスクロール機能がないため、21件目以降のタスクにアクセスできない

### 必要な修正
1. ページネーション機能の追加（ページ番号、前へ/次へボタン）
2. または、仮想スクロール機能の実装
3. または、表示件数選択機能の追加（10/20/50/100件など）

---

## 3. 案件画面のコメント数表示の不整合

### 問題の詳細
- コメントデータがある場合でも、初期表示時はコメント数が0
- コメント表示を開くとコメント数が実際の件数表示される

### 原因分析

#### `/web/app/components/cases/step-comments.tsx` の調査結果

**問題点: 遅延ロードによる初期表示の不整合**
- 61-66行目: コメントの取得は `expanded` が `true` の時のみ実行
```typescript
useEffect(() => {
  if (expanded) {
    fetchComments()
    fetchUsers()
  }
}, [stepId, expanded])
```

- 314-316行目: コメント数の計算はstateのコメント配列から算出
```typescript
const totalComments = comments.reduce((total, comment) => {
  return total + 1 + (comment.replies?.length || 0)
}, 0)
```

**動作フロー**
1. 初期状態: `expanded = false`, `comments = []`
2. コメント数表示: `totalComments = 0`（空配列から計算）
3. ユーザーがコメント欄をクリック: `expanded = true`
4. `fetchComments()`が実行され、実際のコメントを取得
5. コメント数が実際の件数に更新される

**結果**
- 初期表示時はコメントが読み込まれていないため、常に0件と表示
- パフォーマンス最適化のための遅延ロードが、UXの不整合を引き起こしている

### 必要な修正案

**案1: コメント数のみ先行取得**
- コンポーネントのマウント時にコメント数のみを取得するAPIを追加
- 詳細なコメントデータは展開時に取得

**案2: 親コンポーネントからコメント数を渡す**
- ケース詳細取得時にコメント数も含める
- StepCommentsコンポーネントにpropとして渡す

**案3: 初期ロード時にコメント取得**
- パフォーマンスへの影響を考慮しつつ、初期表示時にコメントを取得
- 大量のステップがある場合は要検討

---

## 推奨される対応優先度

1. **高優先度**: 詳細検索の修正
   - 機能が完全に動作していない
   - api-client.tsへの関数追加で解決可能

2. **中優先度**: コメント数表示の修正
   - UXの一貫性に影響
   - 複数の解決方法があり、設計判断が必要

3. **低優先度**: ガントチャートのページネーション
   - 20件以上のタスクがある場合のみ影響
   - UIコンポーネントの追加が必要

## 追加の観察事項

### API URLの設定
- `/web/app/lib/api-client.ts` 4行目で、デフォルトのAPIポートが3001になっている
- 実際は3005で動作しているため、環境変数の設定が重要

### エラーハンドリング
- 多くの箇所でエラーがconsole.errorのみで処理されている
- ユーザーへのフィードバックが不足している可能性