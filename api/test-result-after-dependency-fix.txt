FAIL src/interfaces/controllers/step/step.controller.integration.spec.ts (53.908 s)
  ● Console

    console.log
      prisma:error 
      Invalid `prisma.processTemplate.deleteMany()` invocation in
      /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:35:34
      
        32 await prisma.user.deleteMany({
        33   where: { email: { startsWith: 'test.assignee.' } }
        34 });
      → 35 await prisma.processTemplate.deleteMany(
      Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      at Object.rp (../node_modules/@prisma/internals/src/logger.ts:13:11)

    console.log
      prisma:error 
      Invalid `prisma.processTemplate.deleteMany()` invocation in
      /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:123:34
      
        120 await prisma.user.deleteMany({
        121   where: { email: { startsWith: 'test.' } }
        122 });
      → 123 await prisma.processTemplate.deleteMany(
      Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      at Object.rp (../node_modules/@prisma/internals/src/logger.ts:13:11)

  ● StepController Integration Tests - Assignee Flow › PUT /steps/:id/assignee › should assign a user to a step

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:35:34

      32 await prisma.user.deleteMany({
      33   where: { email: { startsWith: 'test.assignee.' } }
      34 });
    → 35 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      33 |       where: { email: { startsWith: 'test.assignee.' } }
      34 |     });
    > 35 |     await prisma.processTemplate.deleteMany({
         |     ^
      36 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      37 |     });
      38 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/step/step.controller.integration.spec.ts:35:5)

  ● StepController Integration Tests - Assignee Flow › PUT /steps/:id/assignee › should unassign a user from a step

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:35:34

      32 await prisma.user.deleteMany({
      33   where: { email: { startsWith: 'test.assignee.' } }
      34 });
    → 35 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      33 |       where: { email: { startsWith: 'test.assignee.' } }
      34 |     });
    > 35 |     await prisma.processTemplate.deleteMany({
         |     ^
      36 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      37 |     });
      38 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/step/step.controller.integration.spec.ts:35:5)

  ● StepController Integration Tests - Assignee Flow › PUT /steps/:id/assignee › should fail with invalid step ID

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:35:34

      32 await prisma.user.deleteMany({
      33   where: { email: { startsWith: 'test.assignee.' } }
      34 });
    → 35 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      33 |       where: { email: { startsWith: 'test.assignee.' } }
      34 |     });
    > 35 |     await prisma.processTemplate.deleteMany({
         |     ^
      36 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      37 |     });
      38 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/step/step.controller.integration.spec.ts:35:5)

  ● StepController Integration Tests - Assignee Flow › PUT /steps/:id/assignee › should fail with invalid assignee ID

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:35:34

      32 await prisma.user.deleteMany({
      33   where: { email: { startsWith: 'test.assignee.' } }
      34 });
    → 35 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      33 |       where: { email: { startsWith: 'test.assignee.' } }
      34 |     });
    > 35 |     await prisma.processTemplate.deleteMany({
         |     ^
      36 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      37 |     });
      38 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/step/step.controller.integration.spec.ts:35:5)

  ● StepController Integration Tests - Assignee Flow › PUT /steps/:id/assignee › should fail when step is locked

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:35:34

      32 await prisma.user.deleteMany({
      33   where: { email: { startsWith: 'test.assignee.' } }
      34 });
    → 35 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      33 |       where: { email: { startsWith: 'test.assignee.' } }
      34 |     });
    > 35 |     await prisma.processTemplate.deleteMany({
         |     ^
      36 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      37 |     });
      38 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/step/step.controller.integration.spec.ts:35:5)

  ● StepController Integration Tests - Assignee Flow › Assignee workflow integration › should handle complete assignee workflow

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:35:34

      32 await prisma.user.deleteMany({
      33   where: { email: { startsWith: 'test.assignee.' } }
      34 });
    → 35 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      33 |       where: { email: { startsWith: 'test.assignee.' } }
      34 |     });
    > 35 |     await prisma.processTemplate.deleteMany({
         |     ^
      36 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      37 |     });
      38 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/step/step.controller.integration.spec.ts:35:5)

  ● StepController Integration Tests - Assignee Flow › Assignee workflow integration › should support reassignment

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:35:34

      32 await prisma.user.deleteMany({
      33   where: { email: { startsWith: 'test.assignee.' } }
      34 });
    → 35 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      33 |       where: { email: { startsWith: 'test.assignee.' } }
      34 |     });
    > 35 |     await prisma.processTemplate.deleteMany({
         |     ^
      36 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      37 |     });
      38 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/step/step.controller.integration.spec.ts:35:5)


  ● Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:123:34

      120 await prisma.user.deleteMany({
      121   where: { email: { startsWith: 'test.' } }
      122 });
    → 123 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      121 |       where: { email: { startsWith: 'test.' } }
      122 |     });
    > 123 |     await prisma.processTemplate.deleteMany({
          |     ^
      124 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      125 |     });
      126 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/step/step.controller.integration.spec.ts:123:5)

FAIL src/interfaces/controllers/kanban/kanban.controller.integration.spec.ts (10.679 s)
  ● Console

    console.log
      prisma:error 
      Invalid `prisma.processTemplate.deleteMany()` invocation in
      /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/kanban/kanban.controller.integration.spec.ts:147:34
      
        144 await prisma.user.deleteMany({
        145   where: { email: { startsWith: 'test.kanban.' } }
        146 });
      → 147 await prisma.processTemplate.deleteMany(
      Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      at Object.rp (../node_modules/@prisma/internals/src/logger.ts:13:11)

  ● KanbanController Integration Tests - Kanban Operations › GET /kanban/board › should retrieve kanban board with all columns

    expected 200 "OK", got 404 "Not Found"

      156 |       const response = await request(app.getHttpServer())
      157 |         .get('/api/kanban/board')
    > 158 |         .expect(200);
          |          ^
      159 |
      160 |       expect(response.body).toHaveProperty('columns');
      161 |       expect(response.body).toHaveProperty('users');

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:158:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › GET /kanban/board › should filter by assignee

    expected 200 "OK", got 404 "Not Found"

      174 |       const response = await request(app.getHttpServer())
      175 |         .get(`/api/kanban/board?assigneeId=${testAssigneeId}`)
    > 176 |         .expect(200);
          |          ^
      177 |
      178 |       // Check that all items in all columns have the correct assignee
      179 |       for (const column of response.body.columns) {

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:176:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › GET /kanban/board › should filter by case

    expected 200 "OK", got 404 "Not Found"

      189 |       const response = await request(app.getHttpServer())
      190 |         .get(`/api/kanban/board?caseId=${testCaseId}`)
    > 191 |         .expect(200);
          |          ^
      192 |
      193 |       // Check that all items belong to the correct case
      194 |       for (const column of response.body.columns) {

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:191:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › GET /kanban/board › should filter by status

    expected 200 "OK", got 404 "Not Found"

      202 |       const response = await request(app.getHttpServer())
      203 |         .get('/api/kanban/board?status=todo&status=done')
    > 204 |         .expect(200);
          |          ^
      205 |
      206 |       // Check that only todo and done items are returned
      207 |       const allItems: any[] = [];

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:204:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › GET /kanban/board › should include user list

    expected 200 "OK", got 404 "Not Found"

      218 |       const response = await request(app.getHttpServer())
      219 |         .get('/api/kanban/board')
    > 220 |         .expect(200);
          |          ^
      221 |
      222 |       expect(response.body.users).toBeInstanceOf(Array);
      223 |       const testUser = response.body.users.find((u: any) => u.id === testAssigneeId);

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:220:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › GET /kanban/board › should calculate correct statistics

    expected 200 "OK", got 404 "Not Found"

      229 |       const response = await request(app.getHttpServer())
      230 |         .get('/api/kanban/board')
    > 231 |         .expect(200);
          |          ^
      232 |
      233 |       const { stats } = response.body;
      234 |       expect(stats).toHaveProperty('total');

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:231:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › Kanban drag-and-drop workflow › should handle complete drag-and-drop workflow

    expected 200 "OK", got 404 "Not Found"

      254 |       const initialBoard = await request(app.getHttpServer())
      255 |         .get('/api/kanban/board')
    > 256 |         .expect(200);
          |          ^
      257 |
      258 |       const initialTodoItems = initialBoard.body.columns.find((c: any) => c.id === 'todo').items;
      259 |       const initialInProgressItems = initialBoard.body.columns.find((c: any) => c.id === 'in_progress').items;

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:256:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › Kanban drag-and-drop workflow › should enforce WIP limits

    expected 200 "OK", got 404 "Not Found"

      304 |       const response = await request(app.getHttpServer())
      305 |         .get('/api/kanban/board')
    > 306 |         .expect(200);
          |          ^
      307 |
      308 |       // Check that columns have WIP limits defined
      309 |       const inProgressColumn = response.body.columns.find((c: any) => c.id === 'in_progress');

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:306:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › Kanban drag-and-drop workflow › should handle blocked status correctly

    expected 200 "OK", got 404 "Not Found"

      319 |         .put(`/api/steps/${stepId}/status`)
      320 |         .send({ status: 'blocked' })
    > 321 |         .expect(200);
          |          ^
      322 |
      323 |       // Get kanban board
      324 |       const response = await request(app.getHttpServer())

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:321:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › Kanban with multiple users › should show assignee names correctly

    expected 200 "OK", got 404 "Not Found"

      338 |       const response = await request(app.getHttpServer())
      339 |         .get('/api/kanban/board')
    > 340 |         .expect(200);
          |          ^
      341 |
      342 |       // Find items with assignees
      343 |       const itemsWithAssignees: any[] = [];

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:340:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › Kanban with multiple users › should support filtering by multiple assignees

    expected 200 "OK", got 404 "Not Found"

      374 |       const response = await request(app.getHttpServer())
      375 |         .get(`/api/kanban/board?assigneeId=${anotherUser.id}`)
    > 376 |         .expect(200);
          |          ^
      377 |
      378 |       // Verify filtering works
      379 |       let foundCount = 0;

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:376:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)


  ● Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/kanban/kanban.controller.integration.spec.ts:147:34

      144 await prisma.user.deleteMany({
      145   where: { email: { startsWith: 'test.kanban.' } }
      146 });
    → 147 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      145 |       where: { email: { startsWith: 'test.kanban.' } }
      146 |     });
    > 147 |     await prisma.processTemplate.deleteMany({
          |     ^
      148 |       where: { name: { startsWith: 'TEST_KANBAN_TEMPLATE' } }
      149 |     });
      150 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:147:5)

FAIL src/interfaces/controllers/comment/comment.controller.integration.spec.ts (9.163 s)
  ● Console

    console.log
      prisma:error 
      Invalid `prisma.processTemplate.deleteMany()` invocation in
      /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34
      
        42 await prisma.user.deleteMany({
        43   where: { email: { startsWith: 'test.comment.' } }
        44 });
      → 45 await prisma.processTemplate.deleteMany(
      Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      at Object.rp (../node_modules/@prisma/internals/src/logger.ts:13:11)

    console.log
      prisma:error 
      Invalid `prisma.processTemplate.deleteMany()` invocation in
      /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:126:34
      
        123 await prisma.user.deleteMany({
        124   where: { email: { startsWith: 'test.comment.' } }
        125 });
      → 126 await prisma.processTemplate.deleteMany(
      Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      at Object.rp (../node_modules/@prisma/internals/src/logger.ts:13:11)

  ● CommentController Integration Tests - Comment Flow › POST /comments › should create a new comment

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › POST /comments › should fail with invalid step ID

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › POST /comments › should fail with empty content

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › GET /comments/steps/:stepId › should retrieve all comments for a step

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › GET /comments/steps/:stepId › should return empty array for step with no comments

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › PUT /comments/:id › should update a comment

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › PUT /comments/:id › should fail to update non-existent comment

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › DELETE /comments/:id › should delete a comment

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › DELETE /comments/:id › should fail to delete non-existent comment

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › Comment workflow integration › should handle complete comment workflow with replies

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)


  ● Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:126:34

      123 await prisma.user.deleteMany({
      124   where: { email: { startsWith: 'test.comment.' } }
      125 });
    → 126 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      124 |       where: { email: { startsWith: 'test.comment.' } }
      125 |     });
    > 126 |     await prisma.processTemplate.deleteMany({
          |     ^
      127 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      128 |     });
      129 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:126:5)

FAIL src/interfaces/controllers/step/step.controller.simple.spec.ts (6.149 s)
  ● StepController Unit Tests › assignTo › should assign a user to a step

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"assigneeId": 2, "stepId": 1}
    Received: 1, {"assigneeId": 2}

    Number of calls: 1

      112 |       const result = await controller.assignTo(stepId, { assigneeId });
      113 |
    > 114 |       expect(assignStepToUserUseCase.execute).toHaveBeenCalledWith({ stepId, assigneeId });
          |                                               ^
      115 |       expect(result).toHaveProperty('id', 1);
      116 |       expect(result).toHaveProperty('assigneeId', assigneeId);
      117 |     });

      at Object.<anonymous> (interfaces/controllers/step/step.controller.simple.spec.ts:114:47)

  ● StepController Unit Tests › assignTo › should unassign a user when assigneeId is null

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"assigneeId": null, "stepId": 1}
    Received: 1, {"assigneeId": null}

    Number of calls: 1

      125 |       const result = await controller.assignTo(stepId, { assigneeId: null });
      126 |
    > 127 |       expect(assignStepToUserUseCase.execute).toHaveBeenCalledWith({ stepId, assigneeId: null });
          |                                               ^
      128 |       expect(result).toHaveProperty('assigneeId', null);
      129 |     });
      130 |

      at Object.<anonymous> (interfaces/controllers/step/step.controller.simple.spec.ts:127:47)

[31m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [31m  ERROR[39m [38;5;3m[GlobalExceptionFilter] [39m[31m[test-request-id] Internal Server Error[39m
[31m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [31m  ERROR[39m [38;5;3m[GlobalExceptionFilter] [39m[31mError: Something went wrong
    at Object.<anonymous> (/mnt/c/work/git2/process-todo/api/src/common/filters/global-exception.filter.spec.ts:83:25)
    at Promise.finally.completed (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:1559:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:1499:10)
    at _callCircusTest (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:1009:40)
    at _runTest (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:949:3)
    at _runTestsForDescribeBlock (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:839:13)
    at _runTestsForDescribeBlock (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
    at _runTestsForDescribeBlock (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
    at run (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:757:3)
    at runAndTransformResultsToJestFormat (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:1920:21)
    at jestAdapter (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/runner.js:101:19)
    at runTestInternal (/mnt/c/work/git2/process-todo/api/node_modules/jest-runner/build/index.js:275:16)
    at runTest (/mnt/c/work/git2/process-todo/api/node_modules/jest-runner/build/index.js:343:7)[39m
[31m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [31m  ERROR[39m [38;5;3m[GlobalExceptionFilter] [39m[31mObject:[39m
{
  "requestId": "test-request-id",
  "url": "/api/test",
  "method": "GET",
  "ip": "127.0.0.1",
  "userAgent": "test-agent",
  "statusCode": 500,
  "timestamp": "2025-08-16T08:54:37.311Z"
}

[31m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [31m  ERROR[39m [38;5;3m[GlobalExceptionFilter] [39m[31m[test-request-id] Internal Server Error[39m
[31m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [31m  ERROR[39m [38;5;3m[GlobalExceptionFilter] [39m[31mError: Database connection failed: password=secret123
    at Object.<anonymous> (/mnt/c/work/git2/process-todo/api/src/common/filters/global-exception.filter.spec.ts:98:25)
    at Promise.finally.completed (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:1559:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:1499:10)
    at _callCircusTest (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:1009:40)
    at _runTest (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:949:3)
    at _runTestsForDescribeBlock (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:839:13)
    at _runTestsForDescribeBlock (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
    at _runTestsForDescribeBlock (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
    at run (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:757:3)
    at runAndTransformResultsToJestFormat (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:1920:21)
    at jestAdapter (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/runner.js:101:19)
    at runTestInternal (/mnt/c/work/git2/process-todo/api/node_modules/jest-runner/build/index.js:275:16)
    at runTest (/mnt/c/work/git2/process-todo/api/node_modules/jest-runner/build/index.js:343:7)[39m
[31m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [31m  ERROR[39m [38;5;3m[GlobalExceptionFilter] [39m[31mObject:[39m
{
  "requestId": "test-request-id",
  "url": "/api/test",
  "method": "GET",
  "ip": "127.0.0.1",
  "userAgent": "test-agent",
  "statusCode": 500,
  "timestamp": "2025-08-16T08:54:37.329Z"
}

[31m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [31m  ERROR[39m [38;5;3m[GlobalExceptionFilter] [39m[31m[test-request-id] Internal Server Error[39m
[31m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [31m  ERROR[39m [38;5;3m[GlobalExceptionFilter] [39m[31mError: Test error
    at TestFile.js:10:5[39m
[31m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [31m  ERROR[39m [38;5;3m[GlobalExceptionFilter] [39m[31mObject:[39m
{
  "requestId": "test-request-id",
  "url": "/api/test",
  "method": "GET",
  "ip": "127.0.0.1",
  "userAgent": "test-agent",
  "statusCode": 500,
  "timestamp": "2025-08-16T08:54:37.330Z"
}

[31m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [31m  ERROR[39m [38;5;3m[GlobalExceptionFilter] [39m[31m[test-request-id] Internal Server Error[39m
[31m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [31m  ERROR[39m [38;5;3m[GlobalExceptionFilter] [39m[31mError: Test error
    at TestFile.js:10:5[39m
[31m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [31m  ERROR[39m [38;5;3m[GlobalExceptionFilter] [39m[31mObject:[39m
{
  "requestId": "test-request-id",
  "url": "/api/test",
  "method": "GET",
  "ip": "127.0.0.1",
  "userAgent": "test-agent",
  "statusCode": 500,
  "timestamp": "2025-08-16T08:54:37.330Z"
}

FAIL src/common/filters/global-exception.filter.spec.ts
  ● GlobalExceptionFilter › catch › should handle rate limit errors

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"errorCode": "RATE_LIMIT_ERROR", "message": "Too Many Requests", "statusCode": 429}
    Received: {"message": "Too Many Requests", "method": "GET", "path": "/api/test", "requestId": "test-request-id", "statusCode": 429, "timestamp": "2025-08-16T08:54:37.332Z"}

    Number of calls: 1

      184 |
      185 |       expect(mockResponse.status).toHaveBeenCalledWith(HttpStatus.TOO_MANY_REQUESTS);
    > 186 |       expect(mockResponse.json).toHaveBeenCalledWith(
          |                                 ^
      187 |         expect.objectContaining({
      188 |           statusCode: HttpStatus.TOO_MANY_REQUESTS,
      189 |           message: 'Too Many Requests',

      at Object.<anonymous> (common/filters/global-exception.filter.spec.ts:186:33)

[33m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [33m   WARN[39m [38;5;3m[GlobalExceptionFilter] [39m[33m[test-request-id] Client Error: HttpException: Test error[39m
[33m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [33m   WARN[39m [38;5;3m[GlobalExceptionFilter] [39m[33mObject:[39m
{
  "requestId": "test-request-id",
  "url": "/api/test",
  "method": "GET",
  "ip": "127.0.0.1",
  "userAgent": "test-agent",
  "statusCode": 400,
  "timestamp": "2025-08-16T08:54:37.308Z"
}

[33m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [33m   WARN[39m [38;5;3m[GlobalExceptionFilter] [39m[33m[test-request-id] Client Error: HttpException: Http Exception[39m
[33m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [33m   WARN[39m [38;5;3m[GlobalExceptionFilter] [39m[33mObject:[39m
{
  "requestId": "test-request-id",
  "url": "/api/test",
  "method": "GET",
  "ip": "127.0.0.1",
  "userAgent": "test-agent",
  "statusCode": 400,
  "timestamp": "2025-08-16T08:54:37.310Z"
}

[33m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [33m   WARN[39m [38;5;3m[GlobalExceptionFilter] [39m[33m[err_1755334477331_zqo8eerfk] Client Error: HttpException: Test error[39m
[33m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [33m   WARN[39m [38;5;3m[GlobalExceptionFilter] [39m[33mObject:[39m
{
  "requestId": "err_1755334477331_zqo8eerfk",
  "url": "/api/test",
  "method": "GET",
  "ip": "127.0.0.1",
  "userAgent": "test-agent",
  "statusCode": 400,
  "timestamp": "2025-08-16T08:54:37.331Z"
}

[33m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [33m   WARN[39m [38;5;3m[GlobalExceptionFilter] [39m[33m[test-request-id] Client Error: [object Object][39m
[33m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [33m   WARN[39m [38;5;3m[GlobalExceptionFilter] [39m[33mObject:[39m
{
  "requestId": "test-request-id",
  "url": "/api/test",
  "method": "GET",
  "ip": "127.0.0.1",
  "userAgent": "test-agent",
  "statusCode": 409,
  "timestamp": "2025-08-16T08:54:37.332Z"
}

[33m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [33m   WARN[39m [38;5;3m[GlobalExceptionFilter] [39m[33m[test-request-id] Client Error: HttpException: Too Many Requests[39m
[33m[Nest] 562451  - [39m08/16/2025, 5:54:37 PM [33m   WARN[39m [38;5;3m[GlobalExceptionFilter] [39m[33mObject:[39m
{
  "requestId": "test-request-id",
  "url": "/api/test",
  "method": "GET",
  "ip": "127.0.0.1",
  "userAgent": "test-agent",
  "statusCode": 429,
  "timestamp": "2025-08-16T08:54:37.332Z"
}

PASS src/interfaces/controllers/case/case.controller.spec.ts (6.062 s)
  ● Console

    console.error
      Failed to delete case 2: Error: Delete failed
          at Object.<anonymous> (/mnt/c/work/git2/process-todo/api/src/interfaces/controllers/case/case.controller.spec.ts:149:32)
          at Promise.finally.completed (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:1559:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:1499:10)
          at _callCircusTest (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:1009:40)
          at _runTest (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:949:3)
          at _runTestsForDescribeBlock (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:839:13)
          at _runTestsForDescribeBlock (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
          at _runTestsForDescribeBlock (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
          at run (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:757:3)
          at runAndTransformResultsToJestFormat (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/jestAdapterInit.js:1920:21)
          at jestAdapter (/mnt/c/work/git2/process-todo/api/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/mnt/c/work/git2/process-todo/api/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/mnt/c/work/git2/process-todo/api/node_modules/jest-runner/build/index.js:343:7)

      157 |       } catch (error) {
      158 |         // Skip if case doesn't exist or can't be deleted
    > 159 |         console.error(`Failed to delete case ${caseId}:`, error);
          |                 ^
      160 |       }
      161 |     }
      162 |

      at CaseController.bulkDelete (interfaces/controllers/case/case.controller.ts:159:17)
      at Object.<anonymous> (interfaces/controllers/case/case.controller.spec.ts:152:22)

PASS src/interfaces/controllers/step/step.controller.spec.ts (5.637 s)
PASS src/application/dto/process-template/create-process-template.dto.spec.ts (5.322 s)
PASS src/application/dto/process-template/create-step-template.dto.spec.ts
PASS src/interfaces/controllers/auth/auth.controller.spec.ts
[31m[Nest] 562451  - [39m08/16/2025, 5:55:05 PM [31m  ERROR[39m [38;5;3m[ReplanDomainService] [39m[31mDependency 999 not found for template 1:Invalid Step[39m
[31m[Nest] 562451  - [39m08/16/2025, 5:55:05 PM [31m  ERROR[39m [38;5;3m[ReplanDomainService] [39m[31mAvailable template IDs: 1[39m
PASS src/domain/services/replan-domain.service.spec.ts
  ● Console

    console.log
      Step 1:リード獲得 -> 2025-12-01T00:00:00.000Z

      at Object.<anonymous> (domain/services/replan-domain.service.spec.ts:158:17)

    console.log
      Step 2:初回コンタクト -> 2025-12-03T00:00:00.000Z

      at Object.<anonymous> (domain/services/replan-domain.service.spec.ts:158:17)

    console.log
      Step 3:ヒアリング面談 -> 2025-12-06T00:00:00.000Z

      at Object.<anonymous> (domain/services/replan-domain.service.spec.ts:158:17)

PASS src/infrastructure/auth/auth.service.spec.ts
[31m[Nest] 562451  - [39m08/16/2025, 5:55:13 PM [31m  ERROR[39m [38;5;3m[RealtimeGateway] [39m[31mError joining room: Join failed[39m
PASS src/infrastructure/gateways/realtime.gateway.spec.ts
PASS src/infrastructure/auth/guards/permissions.guard.spec.ts
PASS src/infrastructure/auth/jwt.strategy.spec.ts
PASS src/application/usecases/case/create-case.usecase.spec.ts
  ● Console

    console.log
      Schedule Plan: [
        {
          id: 1,
          name: 'Step 1',
          startDate: 2024-12-04T00:00:00.000Z,
          dueDate: 2024-12-17T00:00:00.000Z
        },
        {
          id: 2,
          name: 'Step 2',
          startDate: 2024-12-18T00:00:00.000Z,
          dueDate: 2024-12-24T00:00:00.000Z
        }
      ]

      at CreateCaseUseCase.execute (application/usecases/case/create-case.usecase.ts:57:13)

    console.log
      Creating step instance for Step 1 with start: Wed Dec 04 2024 09:00:00 GMT+0900 (Japan Standard Time), due: Tue Dec 17 2024 09:00:00 GMT+0900 (Japan Standard Time)

      at application/usecases/case/create-case.usecase.ts:66:17
          at Array.map (<anonymous>)

    console.log
        Created instance - Has start date? true

      at application/usecases/case/create-case.usecase.ts:80:17
          at Array.map (<anonymous>)

    console.log
        Start date value: 2024-12-04T00:00:00.000Z

      at application/usecases/case/create-case.usecase.ts:82:19
          at Array.map (<anonymous>)

    console.log
      Creating step instance for Step 2 with start: Wed Dec 18 2024 09:00:00 GMT+0900 (Japan Standard Time), due: Tue Dec 24 2024 09:00:00 GMT+0900 (Japan Standard Time)

      at application/usecases/case/create-case.usecase.ts:66:17
          at Array.map (<anonymous>)

    console.log
        Created instance - Has start date? true

      at application/usecases/case/create-case.usecase.ts:80:17
          at Array.map (<anonymous>)

    console.log
        Start date value: 2024-12-18T00:00:00.000Z

      at application/usecases/case/create-case.usecase.ts:82:19
          at Array.map (<anonymous>)

    console.log
      Schedule Plan: [
        {
          id: 1,
          name: 'Step 1',
          startDate: 2024-12-02T00:00:00.000Z,
          dueDate: 2024-12-13T00:00:00.000Z
        }
      ]

      at CreateCaseUseCase.execute (application/usecases/case/create-case.usecase.ts:57:13)

    console.log
      Creating step instance for Step 1 with start: Mon Dec 02 2024 09:00:00 GMT+0900 (Japan Standard Time), due: Fri Dec 13 2024 09:00:00 GMT+0900 (Japan Standard Time)

      at application/usecases/case/create-case.usecase.ts:66:17
          at Array.map (<anonymous>)

    console.log
        Created instance - Has start date? true

      at application/usecases/case/create-case.usecase.ts:80:17
          at Array.map (<anonymous>)

    console.log
        Start date value: 2024-12-02T00:00:00.000Z

      at application/usecases/case/create-case.usecase.ts:82:19
          at Array.map (<anonymous>)

    console.log
      Schedule Plan: [
        {
          id: 1,
          name: 'Step 1',
          startDate: 2024-11-20T00:00:00.000Z,
          dueDate: 2024-12-10T00:00:00.000Z
        },
        {
          id: 2,
          name: 'Step 2',
          startDate: 2024-12-11T00:00:00.000Z,
          dueDate: 2024-12-17T00:00:00.000Z
        },
        {
          id: 3,
          name: 'Step 3',
          startDate: 2024-12-18T00:00:00.000Z,
          dueDate: 2024-12-20T00:00:00.000Z
        }
      ]

      at CreateCaseUseCase.execute (application/usecases/case/create-case.usecase.ts:57:13)

    console.log
      Creating step instance for Step 1 with start: Wed Nov 20 2024 09:00:00 GMT+0900 (Japan Standard Time), due: Tue Dec 10 2024 09:00:00 GMT+0900 (Japan Standard Time)

      at application/usecases/case/create-case.usecase.ts:66:17
          at Array.map (<anonymous>)

    console.log
        Created instance - Has start date? true

      at application/usecases/case/create-case.usecase.ts:80:17
          at Array.map (<anonymous>)

    console.log
        Start date value: 2024-11-20T00:00:00.000Z

      at application/usecases/case/create-case.usecase.ts:82:19
          at Array.map (<anonymous>)

    console.log
      Creating step instance for Step 2 with start: Wed Dec 11 2024 09:00:00 GMT+0900 (Japan Standard Time), due: Tue Dec 17 2024 09:00:00 GMT+0900 (Japan Standard Time)

      at application/usecases/case/create-case.usecase.ts:66:17
          at Array.map (<anonymous>)

    console.log
        Created instance - Has start date? true

      at application/usecases/case/create-case.usecase.ts:80:17
          at Array.map (<anonymous>)

    console.log
        Start date value: 2024-12-11T00:00:00.000Z

      at application/usecases/case/create-case.usecase.ts:82:19
          at Array.map (<anonymous>)

    console.log
      Creating step instance for Step 3 with start: Wed Dec 18 2024 09:00:00 GMT+0900 (Japan Standard Time), due: Fri Dec 20 2024 09:00:00 GMT+0900 (Japan Standard Time)

      at application/usecases/case/create-case.usecase.ts:66:17
          at Array.map (<anonymous>)

    console.log
        Created instance - Has start date? true

      at application/usecases/case/create-case.usecase.ts:80:17
          at Array.map (<anonymous>)

    console.log
        Start date value: 2024-12-18T00:00:00.000Z

      at application/usecases/case/create-case.usecase.ts:82:19
          at Array.map (<anonymous>)

    console.log
      Schedule Plan: [
        {
          id: 1,
          name: 'Step 1',
          startDate: 2024-12-04T00:00:00.000Z,
          dueDate: 2024-12-17T00:00:00.000Z
        }
      ]

      at CreateCaseUseCase.execute (application/usecases/case/create-case.usecase.ts:57:13)

    console.log
      Creating step instance for Step 1 with start: Wed Dec 04 2024 09:00:00 GMT+0900 (Japan Standard Time), due: Tue Dec 17 2024 09:00:00 GMT+0900 (Japan Standard Time)

      at application/usecases/case/create-case.usecase.ts:66:17
          at Array.map (<anonymous>)

    console.log
        Created instance - Has start date? true

      at application/usecases/case/create-case.usecase.ts:80:17
          at Array.map (<anonymous>)

    console.log
        Start date value: 2024-12-04T00:00:00.000Z

      at application/usecases/case/create-case.usecase.ts:82:19
          at Array.map (<anonymous>)

    console.log
      Schedule Plan: []

      at CreateCaseUseCase.execute (application/usecases/case/create-case.usecase.ts:57:13)

PASS src/infrastructure/auth/guards/roles.guard.spec.ts
PASS src/domain/services/business-day.service.spec.ts
[95m[Nest] 562451  - [39m08/16/2025, 5:55:31 PM [95m  DEBUG[39m [38;5;3m[BusinessDayService] [39m[95maddBusinessDays: startDate=2024-01-01T00:00:00.000Z, businessDays=5, countryCode=JP[39m
[95m[Nest] 562451  - [39m08/16/2025, 5:55:31 PM [95m  DEBUG[39m [38;5;3m[BusinessDayService] [39m[95maddBusinessDays result: 2024-01-08T00:00:00.000Z[39m
[95m[Nest] 562451  - [39m08/16/2025, 5:55:31 PM [95m  DEBUG[39m [38;5;3m[BusinessDayService] [39m[95maddBusinessDays: startDate=2024-01-08T00:00:00.000Z, businessDays=-5, countryCode=JP[39m
[95m[Nest] 562451  - [39m08/16/2025, 5:55:31 PM [95m  DEBUG[39m [38;5;3m[BusinessDayService] [39m[95maddBusinessDays result: 2024-01-01T00:00:00.000Z[39m
[95m[Nest] 562451  - [39m08/16/2025, 5:55:31 PM [95m  DEBUG[39m [38;5;3m[BusinessDayService] [39m[95maddBusinessDays: startDate=2024-01-01T00:00:00.000Z, businessDays=2, countryCode=JP[39m
[95m[Nest] 562451  - [39m08/16/2025, 5:55:31 PM [95m  DEBUG[39m [38;5;3m[BusinessDayService] [39m[95maddBusinessDays result: 2024-01-04T00:00:00.000Z[39m
[95m[Nest] 562451  - [39m08/16/2025, 5:55:31 PM [95m  DEBUG[39m [38;5;3m[BusinessDayService] [39m[95madjustToBusinessDay: date=2024-01-06T00:00:00.000Z, direction=forward[39m
[95m[Nest] 562451  - [39m08/16/2025, 5:55:31 PM [95m  DEBUG[39m [38;5;3m[BusinessDayService] [39m[95maddBusinessDays: startDate=2024-01-06T00:00:00.000Z, businessDays=1, countryCode=JP[39m
[95m[Nest] 562451  - [39m08/16/2025, 5:55:31 PM [95m  DEBUG[39m [38;5;3m[BusinessDayService] [39m[95maddBusinessDays result: 2024-01-08T00:00:00.000Z[39m
[95m[Nest] 562451  - [39m08/16/2025, 5:55:31 PM [95m  DEBUG[39m [38;5;3m[BusinessDayService] [39m[95madjustToBusinessDay: date=2024-01-06T00:00:00.000Z, direction=backward[39m
[95m[Nest] 562451  - [39m08/16/2025, 5:55:31 PM [95m  DEBUG[39m [38;5;3m[BusinessDayService] [39m[95maddBusinessDays: startDate=2024-01-06T00:00:00.000Z, businessDays=-1, countryCode=JP[39m
[95m[Nest] 562451  - [39m08/16/2025, 5:55:31 PM [95m  DEBUG[39m [38;5;3m[BusinessDayService] [39m[95maddBusinessDays result: 2024-01-05T00:00:00.000Z[39m
[95m[Nest] 562451  - [39m08/16/2025, 5:55:31 PM [95m  DEBUG[39m [38;5;3m[BusinessDayService] [39m[95madjustToBusinessDay: date=2024-01-03T00:00:00.000Z, direction=forward[39m
PASS src/domain/entities/step-instance.spec.ts
PASS src/domain/entities/case.spec.ts
PASS src/domain/entities/process-template.spec.ts
PASS src/domain/entities/step-template.spec.ts

Summary of all failing tests
FAIL interfaces/controllers/step/step.controller.integration.spec.ts (53.908 s)
  ● StepController Integration Tests - Assignee Flow › PUT /steps/:id/assignee › should assign a user to a step

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:35:34

      32 await prisma.user.deleteMany({
      33   where: { email: { startsWith: 'test.assignee.' } }
      34 });
    → 35 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      33 |       where: { email: { startsWith: 'test.assignee.' } }
      34 |     });
    > 35 |     await prisma.processTemplate.deleteMany({
         |     ^
      36 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      37 |     });
      38 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/step/step.controller.integration.spec.ts:35:5)

  ● StepController Integration Tests - Assignee Flow › PUT /steps/:id/assignee › should unassign a user from a step

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:35:34

      32 await prisma.user.deleteMany({
      33   where: { email: { startsWith: 'test.assignee.' } }
      34 });
    → 35 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      33 |       where: { email: { startsWith: 'test.assignee.' } }
      34 |     });
    > 35 |     await prisma.processTemplate.deleteMany({
         |     ^
      36 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      37 |     });
      38 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/step/step.controller.integration.spec.ts:35:5)

  ● StepController Integration Tests - Assignee Flow › PUT /steps/:id/assignee › should fail with invalid step ID

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:35:34

      32 await prisma.user.deleteMany({
      33   where: { email: { startsWith: 'test.assignee.' } }
      34 });
    → 35 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      33 |       where: { email: { startsWith: 'test.assignee.' } }
      34 |     });
    > 35 |     await prisma.processTemplate.deleteMany({
         |     ^
      36 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      37 |     });
      38 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/step/step.controller.integration.spec.ts:35:5)

  ● StepController Integration Tests - Assignee Flow › PUT /steps/:id/assignee › should fail with invalid assignee ID

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:35:34

      32 await prisma.user.deleteMany({
      33   where: { email: { startsWith: 'test.assignee.' } }
      34 });
    → 35 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      33 |       where: { email: { startsWith: 'test.assignee.' } }
      34 |     });
    > 35 |     await prisma.processTemplate.deleteMany({
         |     ^
      36 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      37 |     });
      38 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/step/step.controller.integration.spec.ts:35:5)

  ● StepController Integration Tests - Assignee Flow › PUT /steps/:id/assignee › should fail when step is locked

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:35:34

      32 await prisma.user.deleteMany({
      33   where: { email: { startsWith: 'test.assignee.' } }
      34 });
    → 35 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      33 |       where: { email: { startsWith: 'test.assignee.' } }
      34 |     });
    > 35 |     await prisma.processTemplate.deleteMany({
         |     ^
      36 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      37 |     });
      38 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/step/step.controller.integration.spec.ts:35:5)

  ● StepController Integration Tests - Assignee Flow › Assignee workflow integration › should handle complete assignee workflow

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:35:34

      32 await prisma.user.deleteMany({
      33   where: { email: { startsWith: 'test.assignee.' } }
      34 });
    → 35 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      33 |       where: { email: { startsWith: 'test.assignee.' } }
      34 |     });
    > 35 |     await prisma.processTemplate.deleteMany({
         |     ^
      36 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      37 |     });
      38 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/step/step.controller.integration.spec.ts:35:5)

  ● StepController Integration Tests - Assignee Flow › Assignee workflow integration › should support reassignment

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:35:34

      32 await prisma.user.deleteMany({
      33   where: { email: { startsWith: 'test.assignee.' } }
      34 });
    → 35 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      33 |       where: { email: { startsWith: 'test.assignee.' } }
      34 |     });
    > 35 |     await prisma.processTemplate.deleteMany({
         |     ^
      36 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      37 |     });
      38 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/step/step.controller.integration.spec.ts:35:5)


  ● Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/step/step.controller.integration.spec.ts:123:34

      120 await prisma.user.deleteMany({
      121   where: { email: { startsWith: 'test.' } }
      122 });
    → 123 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      121 |       where: { email: { startsWith: 'test.' } }
      122 |     });
    > 123 |     await prisma.processTemplate.deleteMany({
          |     ^
      124 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      125 |     });
      126 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/step/step.controller.integration.spec.ts:123:5)

FAIL interfaces/controllers/kanban/kanban.controller.integration.spec.ts (10.679 s)
  ● KanbanController Integration Tests - Kanban Operations › GET /kanban/board › should retrieve kanban board with all columns

    expected 200 "OK", got 404 "Not Found"

      156 |       const response = await request(app.getHttpServer())
      157 |         .get('/api/kanban/board')
    > 158 |         .expect(200);
          |          ^
      159 |
      160 |       expect(response.body).toHaveProperty('columns');
      161 |       expect(response.body).toHaveProperty('users');

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:158:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › GET /kanban/board › should filter by assignee

    expected 200 "OK", got 404 "Not Found"

      174 |       const response = await request(app.getHttpServer())
      175 |         .get(`/api/kanban/board?assigneeId=${testAssigneeId}`)
    > 176 |         .expect(200);
          |          ^
      177 |
      178 |       // Check that all items in all columns have the correct assignee
      179 |       for (const column of response.body.columns) {

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:176:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › GET /kanban/board › should filter by case

    expected 200 "OK", got 404 "Not Found"

      189 |       const response = await request(app.getHttpServer())
      190 |         .get(`/api/kanban/board?caseId=${testCaseId}`)
    > 191 |         .expect(200);
          |          ^
      192 |
      193 |       // Check that all items belong to the correct case
      194 |       for (const column of response.body.columns) {

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:191:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › GET /kanban/board › should filter by status

    expected 200 "OK", got 404 "Not Found"

      202 |       const response = await request(app.getHttpServer())
      203 |         .get('/api/kanban/board?status=todo&status=done')
    > 204 |         .expect(200);
          |          ^
      205 |
      206 |       // Check that only todo and done items are returned
      207 |       const allItems: any[] = [];

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:204:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › GET /kanban/board › should include user list

    expected 200 "OK", got 404 "Not Found"

      218 |       const response = await request(app.getHttpServer())
      219 |         .get('/api/kanban/board')
    > 220 |         .expect(200);
          |          ^
      221 |
      222 |       expect(response.body.users).toBeInstanceOf(Array);
      223 |       const testUser = response.body.users.find((u: any) => u.id === testAssigneeId);

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:220:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › GET /kanban/board › should calculate correct statistics

    expected 200 "OK", got 404 "Not Found"

      229 |       const response = await request(app.getHttpServer())
      230 |         .get('/api/kanban/board')
    > 231 |         .expect(200);
          |          ^
      232 |
      233 |       const { stats } = response.body;
      234 |       expect(stats).toHaveProperty('total');

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:231:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › Kanban drag-and-drop workflow › should handle complete drag-and-drop workflow

    expected 200 "OK", got 404 "Not Found"

      254 |       const initialBoard = await request(app.getHttpServer())
      255 |         .get('/api/kanban/board')
    > 256 |         .expect(200);
          |          ^
      257 |
      258 |       const initialTodoItems = initialBoard.body.columns.find((c: any) => c.id === 'todo').items;
      259 |       const initialInProgressItems = initialBoard.body.columns.find((c: any) => c.id === 'in_progress').items;

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:256:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › Kanban drag-and-drop workflow › should enforce WIP limits

    expected 200 "OK", got 404 "Not Found"

      304 |       const response = await request(app.getHttpServer())
      305 |         .get('/api/kanban/board')
    > 306 |         .expect(200);
          |          ^
      307 |
      308 |       // Check that columns have WIP limits defined
      309 |       const inProgressColumn = response.body.columns.find((c: any) => c.id === 'in_progress');

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:306:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › Kanban drag-and-drop workflow › should handle blocked status correctly

    expected 200 "OK", got 404 "Not Found"

      319 |         .put(`/api/steps/${stepId}/status`)
      320 |         .send({ status: 'blocked' })
    > 321 |         .expect(200);
          |          ^
      322 |
      323 |       // Get kanban board
      324 |       const response = await request(app.getHttpServer())

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:321:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › Kanban with multiple users › should show assignee names correctly

    expected 200 "OK", got 404 "Not Found"

      338 |       const response = await request(app.getHttpServer())
      339 |         .get('/api/kanban/board')
    > 340 |         .expect(200);
          |          ^
      341 |
      342 |       // Find items with assignees
      343 |       const itemsWithAssignees: any[] = [];

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:340:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)

  ● KanbanController Integration Tests - Kanban Operations › Kanban with multiple users › should support filtering by multiple assignees

    expected 200 "OK", got 404 "Not Found"

      374 |       const response = await request(app.getHttpServer())
      375 |         .get(`/api/kanban/board?assigneeId=${anotherUser.id}`)
    > 376 |         .expect(200);
          |          ^
      377 |
      378 |       // Verify filtering works
      379 |       let foundCount = 0;

      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:376:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:309:14)
      at ../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../node_modules/supertest/lib/test.js:152:11)


  ● Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/kanban/kanban.controller.integration.spec.ts:147:34

      144 await prisma.user.deleteMany({
      145   where: { email: { startsWith: 'test.kanban.' } }
      146 });
    → 147 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      145 |       where: { email: { startsWith: 'test.kanban.' } }
      146 |     });
    > 147 |     await prisma.processTemplate.deleteMany({
          |     ^
      148 |       where: { name: { startsWith: 'TEST_KANBAN_TEMPLATE' } }
      149 |     });
      150 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/kanban/kanban.controller.integration.spec.ts:147:5)

FAIL interfaces/controllers/comment/comment.controller.integration.spec.ts (9.163 s)
  ● CommentController Integration Tests - Comment Flow › POST /comments › should create a new comment

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › POST /comments › should fail with invalid step ID

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › POST /comments › should fail with empty content

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › GET /comments/steps/:stepId › should retrieve all comments for a step

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › GET /comments/steps/:stepId › should return empty array for step with no comments

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › PUT /comments/:id › should update a comment

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › PUT /comments/:id › should fail to update non-existent comment

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › DELETE /comments/:id › should delete a comment

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › DELETE /comments/:id › should fail to delete non-existent comment

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)

  ● CommentController Integration Tests - Comment Flow › Comment workflow integration › should handle complete comment workflow with replies

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:45:34

      42 await prisma.user.deleteMany({
      43   where: { email: { startsWith: 'test.comment.' } }
      44 });
    → 45 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      43 |       where: { email: { startsWith: 'test.comment.' } }
      44 |     });
    > 45 |     await prisma.processTemplate.deleteMany({
         |     ^
      46 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      47 |     });
      48 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:45:5)


  ● Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.processTemplate.deleteMany()` invocation in
    /mnt/c/work/git2/process-todo/api/src/interfaces/controllers/comment/comment.controller.integration.spec.ts:126:34

      123 await prisma.user.deleteMany({
      124   where: { email: { startsWith: 'test.comment.' } }
      125 });
    → 126 await prisma.processTemplate.deleteMany(
    Foreign key constraint violated on the constraint: `step_templates_process_id_fkey`

      124 |       where: { email: { startsWith: 'test.comment.' } }
      125 |     });
    > 126 |     await prisma.processTemplate.deleteMany({
          |     ^
      127 |       where: { name: { startsWith: 'TEST_TEMPLATE_' } }
      128 |     });
      129 |

      at ri.handleRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ri.handleAndLogRequestError (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ri.request (../node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at l (../node_modules/@prisma/client/src/runtime/getPrismaClient.ts:862:24)
      at Object.<anonymous> (interfaces/controllers/comment/comment.controller.integration.spec.ts:126:5)

FAIL interfaces/controllers/step/step.controller.simple.spec.ts (6.149 s)
  ● StepController Unit Tests › assignTo › should assign a user to a step

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"assigneeId": 2, "stepId": 1}
    Received: 1, {"assigneeId": 2}

    Number of calls: 1

      112 |       const result = await controller.assignTo(stepId, { assigneeId });
      113 |
    > 114 |       expect(assignStepToUserUseCase.execute).toHaveBeenCalledWith({ stepId, assigneeId });
          |                                               ^
      115 |       expect(result).toHaveProperty('id', 1);
      116 |       expect(result).toHaveProperty('assigneeId', assigneeId);
      117 |     });

      at Object.<anonymous> (interfaces/controllers/step/step.controller.simple.spec.ts:114:47)

  ● StepController Unit Tests › assignTo › should unassign a user when assigneeId is null

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"assigneeId": null, "stepId": 1}
    Received: 1, {"assigneeId": null}

    Number of calls: 1

      125 |       const result = await controller.assignTo(stepId, { assigneeId: null });
      126 |
    > 127 |       expect(assignStepToUserUseCase.execute).toHaveBeenCalledWith({ stepId, assigneeId: null });
          |                                               ^
      128 |       expect(result).toHaveProperty('assigneeId', null);
      129 |     });
      130 |

      at Object.<anonymous> (interfaces/controllers/step/step.controller.simple.spec.ts:127:47)

FAIL common/filters/global-exception.filter.spec.ts
  ● GlobalExceptionFilter › catch › should handle rate limit errors

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"errorCode": "RATE_LIMIT_ERROR", "message": "Too Many Requests", "statusCode": 429}
    Received: {"message": "Too Many Requests", "method": "GET", "path": "/api/test", "requestId": "test-request-id", "statusCode": 429, "timestamp": "2025-08-16T08:54:37.332Z"}

    Number of calls: 1

      184 |
      185 |       expect(mockResponse.status).toHaveBeenCalledWith(HttpStatus.TOO_MANY_REQUESTS);
    > 186 |       expect(mockResponse.json).toHaveBeenCalledWith(
          |                                 ^
      187 |         expect.objectContaining({
      188 |           statusCode: HttpStatus.TOO_MANY_REQUESTS,
      189 |           message: 'Too Many Requests',

      at Object.<anonymous> (common/filters/global-exception.filter.spec.ts:186:33)


Test Suites: 5 failed, 17 passed, 22 total
Tests:       31 failed, 175 passed, 206 total
Snapshots:   0 total
Time:        140.331 s, estimated 192 s
Ran all test suites.
