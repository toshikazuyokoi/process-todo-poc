# Phase 2.2: 可視化機能強化 - 実装計画書

## 概要
プロセス管理の可視化機能を大幅に強化し、ユーザーが直感的にプロジェクトの状態を把握できるようにする。

## 実装目標
1. **カレンダービュー**: タイムライン形式での期限管理
2. **カンバンボード**: ステータス別のタスク管理
3. **ダッシュボード強化**: KPI表示とメトリクス可視化
4. **リアルタイム更新**: WebSocketによる即時反映

## 実装タスク詳細

### 1. カレンダービュー実装

#### タスク1.1: ライブラリインストールと基本設定
**コーディング**:
- `npm install @fullcalendar/react @fullcalendar/core @fullcalendar/daygrid @fullcalendar/timegrid @fullcalendar/interaction`
- `/web/app/components/calendar/calendar-view.tsx` 作成
- 日本語ロケール設定 (`@fullcalendar/core/locales/ja`)
- Tailwind CSSによるカスタムスタイル定義

**テスト**:
- `calendar-view.test.tsx`: コンポーネントのレンダリングテスト
- ロケール設定の確認テスト
- スタイル適用の確認テスト

#### タスク1.2: 月表示コンポーネント実装
**コーディング**:
```typescript
// /web/app/components/calendar/month-view.tsx
- イベントデータのフォーマット処理
- ケース/ステップのカレンダーイベント変換
- ツールチップ表示機能
- クリックイベントハンドラー
```

**テスト**:
- `month-view.test.tsx`: 
  - イベント表示の正確性テスト
  - 日付計算のテスト
  - イベントクリックのモックテスト
- スナップショットテスト

#### タスク1.3: 週/日表示モード実装
**コーディング**:
```typescript
// /web/app/components/calendar/week-day-view.tsx
- ビュー切り替えロジック
- タイムグリッド表示
- 時間帯別のイベント配置
- スクロール位置の制御
```

**テスト**:
- `week-day-view.test.tsx`:
  - ビュー切り替えテスト
  - 時間帯表示の正確性テスト
  - スクロール動作テスト

#### タスク1.4: ドラッグ&ドロップ機能実装
**コーディング**:
```typescript
// /web/app/hooks/use-calendar-drag-drop.ts
- eventDrop ハンドラー実装
- eventResize ハンドラー実装
- 制約条件の実装（営業日のみ等）
- 楽観的UI更新
```

**テスト**:
- `use-calendar-drag-drop.test.ts`:
  - ドラッグイベントのシミュレーション
  - 制約条件のテスト
  - API呼び出しのモックテスト
- E2Eテスト (`calendar-drag-drop.spec.ts`):
  - 実際のドラッグ操作テスト
  - 期限変更の永続化確認

#### タスク1.5: API連携（期限更新）実装
**コーディング**:
```typescript
// /api/src/interfaces/controllers/calendar/calendar.controller.ts
- GET /api/calendar/events: イベント取得エンドポイント
- PATCH /api/calendar/events/:id: 期限更新エンドポイント
- バリデーションとエラーハンドリング
```

**テスト**:
- `calendar.controller.spec.ts`:
  - エンドポイントのユニットテスト
  - バリデーションテスト
  - エラーケーステスト
- 統合テスト: データベース更新の確認

### 2. カンバンボード実装

#### タスク2.1: 基本レイアウト実装
**コーディング**:
```typescript
// /web/app/components/kanban/kanban-board.tsx
- カラムコンポーネント作成 (Todo, In Progress, Review, Done)
- カラムヘッダー（タイトル、カウント表示）
- レスポンシブレイアウト（横スクロール対応）
- カラム設定（追加/削除/名称変更）
```

**テスト**:
- `kanban-board.test.tsx`:
  - カラムレンダリングテスト
  - レスポンシブ動作テスト
  - カラム設定変更テスト

#### タスク2.2: カード表示とドラッグ&ドロップ実装
**コーディング**:
```typescript
// /web/app/components/kanban/kanban-card.tsx
- カード表示（タイトル、担当者、期限、優先度）
- @dnd-kit/sortable によるドラッグ実装
- カラム間移動のアニメーション
- ドロップ時のステータス更新API呼び出し
```

**テスト**:
- `kanban-card.test.tsx`:
  - カード情報表示テスト
  - ドラッグ開始/終了イベントテスト
- `kanban-drag-drop.test.tsx`:
  - カラム間移動のシミュレーション
  - API呼び出しのモックテスト

#### タスク2.3: WIP制限機能実装
**コーディング**:
```typescript
// /web/app/hooks/use-wip-limit.ts
- カラムごとのWIP制限設定
- 制限超過時の警告表示
- ドロップ拒否ロジック
- 制限値の永続化（localStorage/DB）
```

**テスト**:
- `use-wip-limit.test.ts`:
  - 制限値チェックロジックテスト
  - 警告表示条件テスト
  - ドロップ許可/拒否テスト

#### タスク2.4: フィルタリング機能実装
**コーディング**:
```typescript
// /web/app/components/kanban/kanban-filter.tsx
- 担当者フィルター（複数選択可）
- 優先度フィルター
- 期限フィルター（期限切れ、今週、今月）
- フィルター状態のURL同期
```

**テスト**:
- `kanban-filter.test.tsx`:
  - フィルター適用ロジックテスト
  - 複合フィルターテスト
- E2Eテスト (`kanban-filter.spec.ts`):
  - フィルター操作の統合テスト
  - URL同期の確認

### 3. ダッシュボード強化

#### タスク3.1: KPI計算ロジック実装
**コーディング**:
```typescript
// /web/app/services/kpi-calculator.ts
- 進捗率計算（完了ステップ数/全ステップ数）
- 期限遵守率計算（期限内完了/全完了）
- リソース稼働率計算（アサイン済みタスク/キャパシティ）
- 平均リードタイム計算
- キャッシュ機構の実装
```

**テスト**:
- `kpi-calculator.test.ts`:
  - 各KPI計算ロジックの単体テスト
  - エッジケース（0除算等）のテスト
  - キャッシュ動作テスト
  - パフォーマンステスト（1000件データ）

#### タスク3.2: グラフコンポーネント実装
**コーディング**:
```typescript
// /web/app/components/dashboard/charts/
- burndown-chart.tsx: バーンダウンチャート
- status-pie-chart.tsx: ステータス分布円グラフ
- trend-line-chart.tsx: トレンド分析折れ線グラフ
- resource-bar-chart.tsx: リソース稼働率棒グラフ
```

**テスト**:
- 各チャートコンポーネントのテスト:
  - データフォーマット変換テスト
  - レスポンシブ表示テスト
  - インタラクション（ホバー、クリック）テスト
- スナップショットテスト

#### タスク3.3: ウィジェットレイアウト実装
**コーディング**:
```typescript
// /web/app/components/dashboard/widget-grid.tsx
- react-grid-layout によるグリッドシステム
- ウィジェットの追加/削除UI
- レイアウト設定の保存（localStorage）
- レスポンシブブレークポイント
```

**テスト**:
- `widget-grid.test.tsx`:
  - ドラッグ&ドロップテスト
  - レイアウト保存/復元テスト
  - レスポンシブ動作テスト
- E2Eテスト (`dashboard-layout.spec.ts`)

### 4. リアルタイム更新実装

#### タスク4.1: サーバー側Gateway実装
**コーディング**:
```typescript
// /api/src/gateways/realtime.gateway.ts
- @nestjs/websockets と socket.io のセットアップ
- 認証ミドルウェア実装
- ルーム管理（プロジェクトごと）
- イベントハンドラー定義
```

**テスト**:
- `realtime.gateway.spec.ts`:
  - 接続/切断テスト
  - 認証失敗テスト
  - ルーム参加/退出テスト
  - イベント送受信テスト

#### タスク4.2: クライアント側接続管理実装
**コーディング**:
```typescript
// /web/app/contexts/websocket-context.tsx
- Socket.io-client の初期化
- 自動再接続ロジック（exponential backoff）
- 接続状態管理
- オフライン検出とキューイング
```

**テスト**:
- `websocket-context.test.tsx`:
  - 接続確立テスト
  - 再接続ロジックテスト
  - オフライン時の動作テスト
  - メモリリークテスト

#### タスク4.3: リアルタイム更新機能実装
**コーディング**:
```typescript
// /web/app/hooks/use-realtime-updates.ts
- ケース更新のリスナー
- ステップ状態変更のリスナー
- 楽観的UI更新とロールバック
- 通知表示機能
```

**テスト**:
- `use-realtime-updates.test.ts`:
  - イベント受信時の状態更新テスト
  - 楽観的更新のテスト
  - 競合解決テスト
- E2Eテスト (`realtime-sync.spec.ts`):
  - 複数ブラウザ間の同期テスト
  - レイテンシー測定

## 技術スタック
### フロントエンド
- **FullCalendar**: カレンダービュー
- **@dnd-kit**: カンバンボード
- **Recharts**: データ可視化
- **Socket.io-client**: WebSocket通信
- **date-fns**: 日付処理

### バックエンド
- **@nestjs/websockets**: WebSocketサーバー
- **socket.io**: リアルタイム通信
- **Redis**: PubSub for scaling

## テスト戦略
### ユニットテスト
- カレンダーコンポーネントのテスト
- カンバンボードのドラッグ&ドロップテスト
- ダッシュボードのKPI計算テスト

### 統合テスト
- WebSocket接続テスト
- リアルタイム更新のテスト
- データ同期のテスト

### E2Eテスト
- カレンダービューの操作フロー
- カンバンボードでのタスク移動
- ダッシュボードのインタラクション

## 実装順序とスケジュール（詳細版）

### Week 1: カレンダービュー実装
**Day 1:**
- タスク1.1: ライブラリインストールと基本設定（コーディング + テスト）
- タスク1.2: 月表示コンポーネント実装（コーディング）

**Day 2:**
- タスク1.2: 月表示コンポーネントのテスト
- タスク1.3: 週/日表示モード実装（コーディング + テスト）

**Day 3:**
- タスク1.4: ドラッグ&ドロップ機能実装（コーディング）
- タスク1.4: ドラッグ&ドロップのユニットテスト

**Day 4:**
- タスク1.4: ドラッグ&ドロップのE2Eテスト
- タスク1.5: API連携実装（バックエンド）

**Day 5:**
- タスク1.5: API連携の統合テスト
- カレンダービュー全体の統合テスト
- バグ修正とリファクタリング

### Week 2: カンバンボード実装
**Day 1:**
- タスク2.1: 基本レイアウト実装（コーディング + テスト）
- タスク2.2: カード表示実装（コーディング）

**Day 2:**
- タスク2.2: ドラッグ&ドロップ実装
- タスク2.2: カード機能のテスト

**Day 3:**
- タスク2.3: WIP制限機能実装（コーディング + テスト）
- タスク2.4: フィルタリング機能実装（コーディング）

**Day 4:**
- タスク2.4: フィルタリング機能のテスト
- タスク2.4: フィルタリングのE2Eテスト

**Day 5:**
- カンバンボード全体の統合テスト
- パフォーマンステスト（大量データ）
- バグ修正とリファクタリング

### Week 3: ダッシュボードとWebSocket実装
**Day 1:**
- タスク3.1: KPI計算ロジック実装（コーディング + テスト）
- タスク3.2: グラフコンポーネント実装開始

**Day 2:**
- タスク3.2: グラフコンポーネント完成とテスト
- タスク3.3: ウィジェットレイアウト実装（コーディング）

**Day 3:**
- タスク3.3: ウィジェットレイアウトのテスト
- タスク4.1: サーバー側Gateway実装（コーディング + テスト）

**Day 4:**
- タスク4.2: クライアント側接続管理実装（コーディング + テスト）
- タスク4.3: リアルタイム更新機能実装（コーディング）

**Day 5:**
- タスク4.3: リアルタイム更新のテスト
- 全機能の統合E2Eテスト
- パフォーマンス最適化とバグ修正

## 成功指標
1. **パフォーマンス**: 1000件のデータでも2秒以内に表示
2. **リアルタイム性**: 更新から1秒以内に他ユーザーに反映
3. **使いやすさ**: ドラッグ&ドロップ操作のスムーズさ
4. **可視性**: KPIの一目での把握

## リスクと対策
1. **WebSocketの接続安定性**
   - 対策: 自動再接続とフォールバック機構

2. **大量データのパフォーマンス**
   - 対策: ページネーションと仮想スクロール

3. **ブラウザ互換性**
   - 対策: Polyfillの適用とプログレッシブエンハンスメント

## 実装チェックリスト

### カレンダービュー
- [ ] タスク1.1: ライブラリインストールと基本設定
- [ ] タスク1.1: テスト作成と実行
- [ ] タスク1.2: 月表示コンポーネント実装
- [ ] タスク1.2: ユニットテスト作成と実行
- [ ] タスク1.3: 週/日表示モード実装
- [ ] タスク1.3: ユニットテスト作成と実行
- [ ] タスク1.4: ドラッグ&ドロップ機能実装
- [ ] タスク1.4: E2Eテスト作成と実行
- [ ] タスク1.5: API連携実装
- [ ] タスク1.5: 統合テスト作成と実行

### カンバンボード
- [ ] タスク2.1: 基本レイアウト実装
- [ ] タスク2.1: ユニットテスト作成と実行
- [ ] タスク2.2: カード表示とドラッグ&ドロップ実装
- [ ] タスク2.2: ユニットテスト作成と実行
- [ ] タスク2.3: WIP制限機能実装
- [ ] タスク2.3: ユニットテスト作成と実行
- [ ] タスク2.4: フィルタリング機能実装
- [ ] タスク2.4: E2Eテスト作成と実行

### ダッシュボード
- [ ] タスク3.1: KPI計算ロジック実装
- [ ] タスク3.1: ユニットテスト作成と実行
- [ ] タスク3.2: グラフコンポーネント実装
- [ ] タスク3.2: ユニットテスト作成と実行
- [ ] タスク3.3: ウィジェットレイアウト実装
- [ ] タスク3.3: E2Eテスト作成と実行

### WebSocket/リアルタイム更新
- [ ] タスク4.1: サーバー側Gateway実装
- [ ] タスク4.1: 統合テスト作成と実行
- [ ] タスク4.2: クライアント側接続管理実装
- [ ] タスク4.2: ユニットテスト作成と実行
- [ ] タスク4.3: リアルタイム更新機能実装
- [ ] タスク4.3: E2Eテスト作成と実行

### 品質保証
- [ ] 全機能の統合E2Eテスト実施
- [ ] パフォーマンステスト（1000件データ）
- [ ] メモリリークテスト
- [ ] ブラウザ互換性テスト
- [ ] アクセシビリティチェック

## 参考資料
- [FullCalendar Documentation](https://fullcalendar.io/docs)
- [Socket.io Documentation](https://socket.io/docs/)
- [Recharts Examples](https://recharts.org/en-US/examples)
- [NestJS WebSockets](https://docs.nestjs.com/websockets/gateways)
- [@dnd-kit Documentation](https://docs.dndkit.com/)
- [React Grid Layout](https://github.com/react-grid-layout/react-grid-layout)